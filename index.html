<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1,user-scalable=no" name="viewport"/>
<title>东风Gi16浏览器</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
<style>
:root{--bg:#fff;--fg:#222;--line:#ddd;--accent:#0078ff;--tabBg:#f1f1f1;--tabActive:#fff;--tabText:#000;}
[data-theme="dark"]{--bg:#1e1e1e;--fg:#eaeaea;--line:#444;--accent:#4dabf7;--tabBg:#2c2c2c;--tabActive:#3c3c3c;--tabText:#fff;}
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif;}
body{background:var(--bg);color:var(--fg);-webkit-tap-highlight-color:transparent;}
#wrapper{position:fixed;inset:0;display:flex;flex-direction:column;}
#tabsWrap{display:flex;align-items:center;gap:4px;padding:6px 8px;overflow-x:auto;background:var(--accent);flex-shrink:0;}
#tabsWrap::-webkit-scrollbar{display:none}
.tab{cursor:pointer;white-space:nowrap;padding:6px 10px;border-radius:4px;background:var(--tabBg);color:var(--tabText);font-size:.85rem;flex-shrink:0}
.tab.active{background:var(--tabActive);color:var(--accent)}
.tab .close{margin-left:6px;color:#ff5f6d;font-size:.75rem}
#searchBar{display:flex;flex-wrap:wrap;align-items:center;gap:6px;padding:6px 8px;background:var(--accent);flex-shrink:0;}
#searchBar input{flex:1 1 240px;height:36px;border:none;border-radius:4px;padding:0 8px;font-size:1rem;background:var(--bg);color:var(--fg)}
#searchBar button{height:36px;border:none;border-radius:4px;background:var(--tabActive);color:var(--accent);padding:0 12px;cursor:pointer;-webkit-touch-callout:none;-webkit-user-select:none;}
#searchBar select{background:var(--bg);color:var(--fg);border:1px solid var(--line);border-radius:4px;margin-left:4px;font-size:.9rem;}
iframe{width:100%;height:calc(100vh - 120px);border:none;background:var(--bg)}
#errorText{display:none;text-align:center;margin-top:40px;color:var(--fg)}
#errorText a{color:var(--accent)}
@media(max-width:360px){#searchBar{gap:4px}#searchBar input{font-size:.9rem}#searchBar button{padding:0 10px;font-size:.9rem}}
</style>
</head>
<body data-theme="light">
<div id="wrapper">
  <div id="tabsWrap"></div>
  <div id="searchBar">
    <input id="kwInput" placeholder="输入网址或关键词…"/>
    <button type="button" id="btnSearch"><i class="fas fa-search"></i></button>
    <button type="button" id="btnBack"><i class="fas fa-reply"></i></button>
    <button type="button" id="btnRef"><i class="fas fa-sync-alt"></i></button>
    <select id="themeSel"><option value="light">☀️ 浅色</option><option value="dark">⭐️ 深色</option></select>
    <select id="langSel"><option value="zh">🇨🇳简体中文</option><option value="en">🇺🇸English</option></select>
    <!-- UA 选择器：仅展示，不可改 -->
    <select id="uaSel" disabled></select>
  </div>
  <iframe id="frameBox" src="about:blank"></iframe>
  <div id="errorText">
    <span id="errMsg">加载失败</span><br/>
    <a id="openNewTab" href="about:blank" target="_blank">在新标签页打开</a>
  </div>
</div>

<script>
/* ========== 多语言 ========== */
const i18n={zh:{placeholder:'输入网址或关键词…',newTab:'新标签页',fail:'加载失败'},en:{placeholder:'Enter URL or keyword…',newTab:'New Tab',fail:'Load failed'}};
let LANG='zh';
function T(k){return i18n[LANG][k]||k}

/* ========== 记忆 ========== */
function readMem(){
  const c=document.cookie.match(/ew16=(\w+):(\w+):([^;]+)/);
  return {theme:(c&&c[1])||'light',lang:(c&&c[2])||'zh',ua:(c&&c[3])||'默认系统UA'};
}
function saveMem(){
  const arr=[themeSel.value,langSel.value,uaSel.value];
  document.cookie=`ew16=${arr.join(':')};path=/;max-age=31536000`;
}
const mem=readMem();
document.documentElement.setAttribute('data-theme',mem.theme);
LANG=mem.lang;

/* ========== 初始化控件 ========== */
themeSel.value=mem.theme; langSel.value=mem.lang;
buildUaSel(mem.ua);
document.getElementById('kwInput').placeholder=T('placeholder');
document.getElementById('errMsg').innerText=T('fail');

/* ========== 主题 & 语言：不刷新整页 ========== */
themeSel.onchange=(e=>{
  saveMem();
  document.documentElement.setAttribute('data-theme',e.target.value);
  if(activeId){
    const tab=tabs.find(t=>t.id===activeId);
    if(tab){
      const f=document.getElementById('frameBox');
      f.src='about:blank';setTimeout(()=>f.src=tab.url,50);
    }
  }
});
langSel.onchange=(e=>{
  saveMem();
  LANG=e.target.value;
  document.getElementById('kwInput').placeholder=T('placeholder');
  document.getElementById('errMsg').innerText=T('fail');
  if(activeId){
    const tab=tabs.find(t=>t.id===activeId);
    if(tab){
      const f=document.getElementById('frameBox');
      f.src='about:blank';setTimeout(()=>f.src=tab.url,50);
    }
  }
});

/* ========== UA 选择器：仅展示，锁死 ========== */
function buildUaSel(def){
  const sel=document.getElementById('uaSel');
  sel.innerHTML='';
  sel.add(new Option(def,def,true,true));
  sel.disabled=true;
}

/* ========== 标签页管理 ========== */
let tabs=[];let activeId=null;
function renderTabs(){
  const wrap=document.getElementById('tabsWrap');
  wrap.innerHTML='';
  tabs.forEach(t=>{
    const span=document.createElement('span');
    span.className='tab'+(t.id===activeId?' active':'');
    span.innerHTML=`${t.title}<i class="fas fa-times close" onclick="delTab(${t.id},event)"></i>`;
    span.onclick=(e)=>{if(!e.target.classList.contains('close'))switchTab(t.id)};
    wrap.appendChild(span);
  });
}
function addTab(title,url){
  const id=Date.now();
  tabs.push({id,title,url});
  activeId=id;
  renderTabs();
  loadUrl(url);
}
function switchTab(id){activeId=id;renderTabs();document.getElementById('frameBox').src=tabs.find(t=>t.id===id).url}
function delTab(id,e){
  e.stopPropagation();
  tabs=tabs.filter(t=>t.id!==id);
  if(activeId===id){activeId=tabs.length?tabs[tabs.length-1].id:null}
  renderTabs();
  document.getElementById('frameBox').src=activeId?tabs.find(t=>t.id===activeId).url:'about:blank';
}

/* ========== 搜索 / 跳转 ========== */
function goSearch(){
  const raw=document.getElementById('kwInput').value.trim();
  if(!raw)return;
  const isUrl=/^https?:\/\//.test(raw)||/\.\w+$/.test(raw);
  if(isUrl){
    let url=raw;if(!url.startsWith('http'))url='https://'+url;
    const exist=tabs.find(t=>t.url===url);
    if(exist){switchTab(exist.id)}else{addTab(url,url)}
  }else{
    window.location.href='https://www.bing.com/search?q='+encodeURIComponent(raw);
  }
}
document.getElementById('btnSearch').addEventListener('click',goSearch);
document.getElementById('kwInput').addEventListener('keydown',e=>{if(e.key==='Enter')goSearch()});

/* ========== 工具按钮 ========== */
document.getElementById('btnBack').addEventListener('click',()=>{
  const f=document.getElementById('frameBox');
  try{f.contentWindow.history.back()}catch(e){history.back()}
});
document.getElementById('btnRef').addEventListener('click',()=>{
  if(activeId){
    const tab=tabs.find(t=>t.id===activeId);
    if(tab)loadUrl(tab.url);
  }
});

/* ========== 载入 + 标题嗅探 ========== */
function loadUrl(url){
  const f=document.getElementById('frameBox');
  const err=document.getElementById('errorText');
  const link=document.getElementById('openNewTab');
  f.style.display='block';err.style.display='none';
  f.src=url;
  const t=setTimeout(()=>{f.style.display='none';err.style.display='block';link.href=url},5000);
  f.onload=()=>{
    clearTimeout(t);
    try{
      const title=f.contentDocument.title||T('newTab');
      const tab=tabs.find(t=>t.id===activeId);
      if(tab){tab.title=title;renderTabs();}
    }catch{/*跨域*/}
  };
  f.onerror=()=>clearTimeout(t);
}

/* ========== 初始欢迎页 ========== */
window.onload=()=>{
  if(tabs.length===0)addTab('欢迎页','https://dongshengamestudio.github.io/HelloEastWindGi16Browser/');
};
</script>
</body></html>