<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>ä¸œç¥å·¥ä½œå®¤ Â· å…¨éƒ½è¦æµè§ˆå™¨</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
<style>
:root{
  --bg:#ffffff;--fg:#222;--line:#ddd;--accent:#0078ff;--tabBg:#f1f1f1;--tabActive:#fff;--tabText:#000;
}
[data-theme="dark"]{
  --bg:#1e1e1e;--fg:#eaeaea;--line:#444;--accent:#4dabf7;--tabBg:#2c2c2c;--tabActive:#3c3c3c;--tabText:#fff;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif}
body{background:var(--bg);color:var(--fg)}
#wrapper{position:fixed;inset:0;display:flex;flex-direction:column;}
#tabsWrap{display:flex;align-items:center;gap:4px;padding:6px 8px;overflow-x:auto;background:var(--accent);flex-shrink:0;}
#tabsWrap::-webkit-scrollbar{display:none}
.tab{cursor:pointer;white-space:nowrap;padding:6px 10px;border-radius:4px;background:var(--tabBg);color:var(--tabText);font-size:.85rem;flex-shrink:0}
.tab.active{background:var(--tabActive);color:var(--accent)}
.tab .close{margin-left:6px;color:#ff5f6d;font-size:.75rem}
#searchBar{display:flex;align-items:center;gap:6px;padding:6px 8px;background:var(--accent);flex-shrink:0;}
#searchBar input{flex:1;height:36px;border:none;border-radius:4px;padding:0 8px;font-size:1rem;background:var(--bg);color:var(--fg)}
#searchBar button{height:36px;border:none;border-radius:4px;background:var(--tabActive);color:var(--accent);padding:0 12px;cursor:pointer}
#searchBar select{background:var(--bg);color:var(--fg);border:1px solid var(--line);border-radius:4px;margin-left:4px}
iframe{width:100%;height:calc(100vh - 120px);border:none;background:var(--bg)}
#errorText{display:none;text-align:center;margin-top:40px;color:var(--fg)}
#errorText a{color:var(--accent)}
.dlBtn{margin-left:auto;background:#28a745!important;color:#fff!important}
</style>
</head>
<body data-theme="light">
<div id="wrapper">
  <div id="tabsWrap"></div>

  <div id="searchBar">
    <input id="kwInput" placeholder="è¾“å…¥ç½‘å€æˆ–å…³é”®è¯â€¦" onkeydown="if(event.key==='Enter')goSearch()"/>
    <button onclick="goSearch()"><i class="fas fa-search"></i></button>
    <button onclick="historyBack()"><i class="fas fa-reply"></i></button>
    <button onclick="refreshFrame()"><i class="fas fa-sync-alt"></i></button>
    <select id="themeSel"><option value="light">ğŸŒ æµ…è‰²</option><option value="dark">ğŸŒ™ æ·±è‰²</option></select>
    <select id="langSel"><option value="zh">ç®€ä½“ä¸­æ–‡</option><option value="en">English</option></select>
    <select id="uaSel"></select>
    <button class="dlBtn" onclick="downloadCurrent()"><i class="fas fa-download"></i> ä¸‹è½½æ–‡ä»¶</button>
  </div>

  <iframe id="frameBox" src="about:blank"></iframe>
  <div id="errorText">
    åŠ è½½å¤±è´¥ï¼Œå¯èƒ½è¢«é™åˆ¶åµŒå…¥ã€‚<br/>
    <a id="openNewTab" href="about:blank" target="_blank">åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€</a>
  </div>
</div>

<script>
/* ====== å¤šè¯­è¨€ ====== */
const i18n={
  zh:{newTab:'æ–°æ ‡ç­¾é¡µ',down:'ä¸‹è½½æ–‡ä»¶',placeholder:'è¾“å…¥ç½‘å€æˆ–å…³é”®è¯â€¦',fail:'åŠ è½½å¤±è´¥'},
  en:{newTab:'New Tab',down:'Download',placeholder:'Enter URL or keywordâ€¦',fail:'Load failed'}
};
let LANG='zh';
function T(k){return i18n[LANG][k]||k}

/* ====== UA åˆ—è¡¨ ====== */
const UA_LIST={
  'eDEX (é»˜è®¤)':'Mozilla/5.0 (compatible; eDEX/1.0)',
  'Windows':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
  'Android':'Mozilla/5.0 (Linux; Android 13) AppleWebKit/537.36',
  'iPhone':'Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/537.36',
  'iPad':'Mozilla/5.0 (iPad; CPU OS 16_0 like Mac OS X) AppleWebKit/537.36',
  'Linux':'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36',
  'Mac':'Mozilla/5.0 (Macintosh; Intel Mac OS X 13_0) AppleWebKit/537.36',
  'X11':'Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.1)'
};

/* ====== è®°å¿†æ¢å¤ ====== */
const storage=window.localStorage;
function loadMem(){
  const t=storage.getItem('theme')||'light';
  const l=storage.getItem('lang')||'zh';
  const u=storage.getItem('ua')||'eDEX (é»˜è®¤)';
  document.documentElement.setAttribute('data-theme',t);
  themeSel.value=t; langSel.value=l;
  setLang(l);
  buildUaSel(u);
}
loadMem();

themeSel.onchange=e=>{const v=e.target.value; storage.setItem('theme',v); document.documentElement.setAttribute('data-theme',v)};
langSel.onchange=e=>{const v=e.target.value; storage.setItem('lang',v); setLang(v); location.reload()}; // ç®€æ˜“åˆ·æ–°
uaSel.onchange=e=>{const v=e.target.value; storage.setItem('ua',v); location.reload()};

function setLang(l){LANG=l; document.getElementById('kwInput').placeholder=T('placeholder')}

function buildUaSel(def){
  const sel=document.getElementById('uaSel');
  sel.innerHTML='';
  for(const [name,ua] of Object.entries(UA_LIST)){
    const op=new Option(name,name); op.selected=name===def; sel.add(op);
  }
  if(def&&UA_LIST[def])Object.defineProperty(navigator,'userAgent',{value:UA_LIST[def],writable:false,configurable:true});
}

/* ====== æ ‡ç­¾é¡µç®¡ç† ====== */
let tabs=[]; let activeId=null;
function renderTabs(){
  const wrap=document.getElementById('tabsWrap');
  wrap.innerHTML='';
  tabs.forEach(t=>{
    const span=document.createElement('span');
    span.className='tab'+(t.id===activeId?' active':'');
    span.innerHTML=`${t.title}<i class="fas fa-times close" onclick="delTab(${t.id},event)"></i>`;
    span.onclick=(e)=>{if(!e.target.classList.contains('close'))switchTab(t.id)};
    wrap.appendChild(span);
  });
}
function addTab(title,url){
  const id=Date.now();
  tabs.push({id,title,url});
  activeId=id;
  renderTabs();
  loadUrl(url);
}
function switchTab(id){activeId=id; renderTabs(); document.getElementById('frameBox').src=tabs.find(t=>t.id===id).url}
function delTab(id,e){
  e.stopPropagation();
  tabs=tabs.filter(t=>t.id!==id);
  if(activeId===id){activeId=tabs.length?tabs[tabs.length-1].id:null}
  renderTabs();
  document.getElementById('frameBox').src=activeId?tabs.find(t=>t.id===activeId).url:'about:blank';
}

/* ====== æ™ºèƒ½ç½‘å€/æœç´¢åˆ†æµ ====== */
function goSearch(){
  const raw=document.getElementById('kwInput').value.trim();
  if(!raw)return;
  const isUrl=/^https?:\/\//.test(raw)||/\.\w+$/.test(raw);
  if(isUrl){
    let url=raw; if(!url.startsWith('http'))url='https://'+url;
    const exist=tabs.find(t=>t.url===url);
    if(exist){switchTab(exist.id)}else{addTab(url,url)}
  }else{
    // å…³é”®è¯ â†’ æ•´é¡µè·³è½¬ Bingï¼Œä¸è¢«æ‹¦æˆª
    window.location.href='https://www.bing.com/search?q='+encodeURIComponent(raw);
  }
}

/* ====== è½½å…¥åœ°å€ + æ ‡é¢˜å—…æ¢ ====== */
function loadUrl(url){
  const f=document.getElementById('frameBox');
  const err=document.getElementById('errorText');
  const link=document.getElementById('openNewTab');
  f.style.display='block'; err.style.display='none';
  f.src=url;
  const t=setTimeout(()=>{f.style.display='none'; err.style.display='block'; link.href=url},5000);
  f.onload=()=>{
    clearTimeout(t);
    try{
      const title=f.contentDocument.title||T('newTab');
      const tab=tabs.find(t=>t.id===activeId);
      if(tab){tab.title=title; renderTabs();}
    }catch{/*è·¨åŸŸ*/}
  };
  f.onerror=()=>clearTimeout(t);
}

/* ====== ä¸‹è½½å½“å‰èµ„æº ====== */
function downloadCurrent(){
  const f=document.getElementById('frameBox');
  const url=f.src;
  if(!url||url==='about:blank')return alert('æš‚æ— é¡µé¢å¯ä¸‹è½½');
  // åˆ›å»º a æ ‡ç­¾è§¦å‘ç³»ç»Ÿä¸‹è½½å™¨
  const a=document.createElement('a');
  a.href=url;
  a.download=''; // è®©æµè§ˆå™¨è‡ªåŠ¨è¯†åˆ«æ–‡ä»¶å
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

/* ====== å·¥å…·æŒ‰é’® ====== */
function historyBack(){
  const f=document.getElementById('frameBox');
  try{f.contentWindow.history.back()}catch(e){history.back()}
}
function refreshFrame(){
  if(activeId){
    const tab=tabs.find(t=>t.id===activeId);
    if(tab)loadUrl(tab.url);
  }
}

/* ====== åˆå§‹æ¬¢è¿é¡µ ====== */
window.onload=()=>{
  if(tabs.length===0)addTab('æ¬¢è¿é¡µ',https://dongshengamestudio.github.io/HelloEastWindGi16Browser/'');
};
</script>
</body></html>